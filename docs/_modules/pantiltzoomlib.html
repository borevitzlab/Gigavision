<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pantiltzoomlib &#8212; Gigavision 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Gigavision</a></h1>



<p class="blurb">Capture/Control/Upload software for panorama grids capture systems.</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=borevitzlab&repo=Gigavision&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ansible.html">Ansible Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../genindex.html">General Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py-modindex.html">Module Index</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pantiltzoomlib</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Mon Nov 17 10:24:49 2014</span>

<span class="sd">:author: chuong nguyen, chuong.nguyen@anu.edu.au</span>
<span class="sd">:author: Gareth Dunstone, gareth.dunstone@anu.edu.au</span>


<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">logging.config</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">libs.Uploader</span> <span class="k">import</span> <span class="n">GenericUploader</span>
<span class="kn">from</span> <span class="nn">libs.Updater</span> <span class="k">import</span> <span class="n">Updater</span>
<span class="kn">from</span> <span class="nn">libs.Camera</span> <span class="k">import</span> <span class="n">Camera</span><span class="p">,</span> <span class="n">GPCamera</span><span class="p">,</span> <span class="n">IPCamera</span>
<span class="kn">from</span> <span class="nn">libs.PanTilt</span> <span class="k">import</span> <span class="n">PanTilt</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fileConfig</span><span class="p">(</span><span class="s2">&quot;logging.ini&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;paramiko&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>


<div class="viewcode-block" id="draw_matches_opencv"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.draw_matches_opencv">[docs]</a><span class="k">def</span> <span class="nf">draw_matches_opencv</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">kp1</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">kp2</span><span class="p">,</span> <span class="n">matches</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Source: http://stackoverflow.com/questions/20259025/module-object-has-no-attribute-drawmatches-opencv-python</span>
<span class="sd">    This function takes in two images with their associated</span>
<span class="sd">    keypoints, as well as a list of DMatch data structure (matches)</span>
<span class="sd">    that contains which keypoints matched in which images.</span>

<span class="sd">    An image will be produced where a montage is shown with the first image followed</span>
<span class="sd">    by the second image beside it.</span>

<span class="sd">    Keypoints are delineated with circles, while lines are connected between</span>
<span class="sd">    matching keypoints.</span>

<span class="sd">    :param img1: grayscale image</span>
<span class="sd">    :type img1: np.ndarray</span>
<span class="sd">    :param kp1: Detected list of keypoints through any of the OpenCV keypoint detection algorithms</span>
<span class="sd">    :type kp1: list</span>
<span class="sd">    :param img2: grayscale image</span>
<span class="sd">    :type img2: np.ndarray</span>
<span class="sd">    :param kp2: Detected list of keypoints through any of the OpenCV keypoint detection algorithms</span>
<span class="sd">    :type kp2: list</span>
<span class="sd">    :param matches: A list of matches of corresponding keypoints through any OpenCV keypoint matching algorithm</span>
<span class="sd">    :type matches: list</span>
<span class="sd">    :return: image of matches between images.</span>
<span class="sd">    :rtype: np.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">cv2</span>
    <span class="c1"># define a taget height</span>
    <span class="n">TARGETHEIGHT</span> <span class="o">=</span> <span class="mi">800</span>

    <span class="c1"># Create a new output image that concatenates the two images together</span>
    <span class="c1"># (a.k.a) a montage</span>
    <span class="n">rows1</span> <span class="o">=</span> <span class="n">img1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cols1</span> <span class="o">=</span> <span class="n">img1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rows2</span> <span class="o">=</span> <span class="n">img2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cols2</span> <span class="o">=</span> <span class="n">img2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">max</span><span class="p">([</span><span class="n">rows1</span><span class="p">,</span> <span class="n">rows2</span><span class="p">]),</span> <span class="n">cols1</span> <span class="o">+</span> <span class="n">cols2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>


    <span class="c1"># Place the first image to the left</span>
    <span class="n">out</span><span class="p">[:</span><span class="n">rows1</span><span class="p">,</span> <span class="p">:</span><span class="n">cols1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">img1</span><span class="p">,</span> <span class="n">img1</span><span class="p">,</span> <span class="n">img1</span><span class="p">])</span>

    <span class="c1"># Place the next image to the right of it</span>
    <span class="n">out</span><span class="p">[:</span><span class="n">rows2</span><span class="p">,</span> <span class="n">cols1</span><span class="p">:</span><span class="n">cols1</span> <span class="o">+</span> <span class="n">cols2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">img2</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">img2</span><span class="p">])</span>
    <span class="n">ar</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">TARGETHEIGHT</span> <span class="o">*</span> <span class="n">ar</span><span class="p">)</span>
    <span class="c1"># For each pair of points we have between both images</span>
    <span class="c1"># draw circles, then connect a line between them</span>
    <span class="k">for</span> <span class="n">mat</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="c1"># Get the matching keypoints for each of the images</span>
        <span class="n">img1_idx</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">queryIdx</span>
        <span class="n">img2_idx</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">trainIdx</span>

        <span class="c1"># x - columns</span>
        <span class="c1"># y - rows</span>
        <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="o">=</span> <span class="n">kp1</span><span class="p">[</span><span class="n">img1_idx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span>
        <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span> <span class="o">=</span> <span class="n">kp2</span><span class="p">[</span><span class="n">img2_idx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span>

        <span class="c1"># Draw a small circle at both co-ordinates</span>
        <span class="c1"># radius 4</span>
        <span class="c1"># colour blue</span>
        <span class="c1"># thickness = 1</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y1</span><span class="p">)),</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> <span class="o">+</span> <span class="n">cols1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">y2</span><span class="p">)),</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Draw a line in between the two points</span>
        <span class="c1"># thickness = 3</span>
        <span class="c1"># colour red green blue</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y1</span><span class="p">)),</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> <span class="o">+</span> <span class="n">cols1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">y2</span><span class="p">)),</span>
                 <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">TARGETHEIGHT</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>

    <span class="c1"># rescale image here.</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">TARGETHEIGHT</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="get_displacement_opencv"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.get_displacement_opencv">[docs]</a><span class="k">def</span> <span class="nf">get_displacement_opencv</span><span class="p">(</span><span class="n">image0</span><span class="p">,</span> <span class="n">image1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets displacement (in pixels I think) difference between 2 images using opencv</span>

<span class="sd">    :param image0: reference image</span>
<span class="sd">    :type image0: np.ndarray</span>
<span class="sd">    :param image1: target image</span>
<span class="sd">    :type image1: np.ndarray</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image0</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

    <span class="c1"># Create ORB detector with 1000 keypoints with a scaling pyramid factor of 1.2</span>
    <span class="c1"># gareth changed here from cv2.ORB to cv2.ORB_create for opencv3.1.0 compatibility.</span>
    <span class="n">orb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ORB_create</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>

    <span class="c1"># Detect keypoints</span>
    <span class="p">(</span><span class="n">kp1</span><span class="p">,</span> <span class="n">des1</span><span class="p">)</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">(</span><span class="n">kp2</span><span class="p">,</span> <span class="n">des2</span><span class="p">)</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Create matcher and do matching</span>
    <span class="n">bf</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_HAMMING</span><span class="p">,</span> <span class="n">crossCheck</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">)</span>

    <span class="c1"># Sort the matches based on distance.  Least distance</span>
    <span class="c1"># is better</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">distance</span><span class="p">)</span>

    <span class="c1"># collect displacement from the first 10 matches</span>
    <span class="n">dx_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dy_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mat</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">[:</span><span class="mi">20</span><span class="p">]:</span>
        <span class="c1"># Get the matching keypoints for each of the images</span>
        <span class="n">img1_idx</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">queryIdx</span>
        <span class="n">img2_idx</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">trainIdx</span>

        <span class="c1"># x - columns</span>
        <span class="c1"># y - rows</span>
        <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="o">=</span> <span class="n">kp1</span><span class="p">[</span><span class="n">img1_idx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span>
        <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span> <span class="o">=</span> <span class="n">kp2</span><span class="p">[</span><span class="n">img2_idx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span>
        <span class="n">dx_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">))</span>
        <span class="n">dy_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">))</span>

    <span class="n">dx_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dx_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">))</span>
    <span class="n">dy_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dy_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">))</span>

    <span class="n">img3</span> <span class="o">=</span> <span class="n">draw_matches_opencv</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">kp1</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">kp2</span><span class="p">,</span> <span class="n">matches</span><span class="p">[:</span><span class="mi">20</span><span class="p">])</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&quot;matches.jpg&quot;</span><span class="p">,</span> <span class="n">img3</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">img1</span>
    <span class="k">del</span> <span class="n">img2</span>
    <span class="k">return</span> <span class="n">dx_median</span><span class="p">,</span> <span class="n">dy_median</span></div>


<div class="viewcode-block" id="get_displacement"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.get_displacement">[docs]</a><span class="k">def</span> <span class="nf">get_displacement</span><span class="p">(</span><span class="n">image0</span><span class="p">,</span> <span class="n">image1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets displacement (in pixels I think) difference between 2 images using scikit-image</span>
<span class="sd">    not as accurate as the opencv version i think.</span>

<span class="sd">    :param image0: reference image</span>
<span class="sd">    :param image1: target image</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="k">import</span> <span class="p">(</span><span class="n">match_descriptors</span><span class="p">,</span> <span class="n">ORB</span><span class="p">,</span> <span class="n">plot_matches</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">skimage.color</span> <span class="k">import</span> <span class="n">rgb2gray</span>
    <span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="k">import</span> <span class="n">hamming</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">misc</span>
    <span class="n">image0_gray</span> <span class="o">=</span> <span class="n">rgb2gray</span><span class="p">(</span><span class="n">image0</span><span class="p">)</span>
    <span class="n">image1_gray</span> <span class="o">=</span> <span class="n">rgb2gray</span><span class="p">(</span><span class="n">image1</span><span class="p">)</span>
    <span class="n">descriptor_extractor</span> <span class="o">=</span> <span class="n">ORB</span><span class="p">(</span><span class="n">n_keypoints</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

    <span class="n">descriptor_extractor</span><span class="o">.</span><span class="n">detect_and_extract</span><span class="p">(</span><span class="n">image0_gray</span><span class="p">)</span>
    <span class="n">keypoints1</span> <span class="o">=</span> <span class="n">descriptor_extractor</span><span class="o">.</span><span class="n">keypoints</span>
    <span class="n">descriptors1</span> <span class="o">=</span> <span class="n">descriptor_extractor</span><span class="o">.</span><span class="n">descriptors</span>

    <span class="n">descriptor_extractor</span><span class="o">.</span><span class="n">detect_and_extract</span><span class="p">(</span><span class="n">image1_gray</span><span class="p">)</span>
    <span class="n">keypoints2</span> <span class="o">=</span> <span class="n">descriptor_extractor</span><span class="o">.</span><span class="n">keypoints</span>
    <span class="n">descriptors2</span> <span class="o">=</span> <span class="n">descriptor_extractor</span><span class="o">.</span><span class="n">descriptors</span>

    <span class="n">matches12</span> <span class="o">=</span> <span class="n">match_descriptors</span><span class="p">(</span><span class="n">descriptors1</span><span class="p">,</span> <span class="n">descriptors2</span><span class="p">,</span> <span class="n">cross_check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Sort the matches based on distance.  Least distance</span>
    <span class="c1"># is better</span>
    <span class="n">distances12</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches12</span><span class="p">:</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">hamming</span><span class="p">(</span><span class="n">descriptors1</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">descriptors2</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">distances12</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matches12</span><span class="p">))</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">distances12</span><span class="p">,</span> <span class="n">indices</span><span class="p">))]</span>
    <span class="n">matches12</span> <span class="o">=</span> <span class="n">matches12</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

    <span class="c1"># collect displacement from the first 10 matches</span>
    <span class="n">dx_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dy_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mat</span> <span class="ow">in</span> <span class="n">matches12</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>
        <span class="c1"># Get the matching key points for each of the images</span>
        <span class="n">img1_idx</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">img2_idx</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># x - columns</span>
        <span class="c1"># y - rows</span>
        <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="o">=</span> <span class="n">keypoints1</span><span class="p">[</span><span class="n">img1_idx</span><span class="p">]</span>
        <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span> <span class="o">=</span> <span class="n">keypoints2</span><span class="p">[</span><span class="n">img2_idx</span><span class="p">]</span>
        <span class="n">dx_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">))</span>
        <span class="n">dy_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">))</span>

    <span class="n">dx_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dx_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">))</span>
    <span class="n">dy_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dy_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">))</span>
    <span class="c1"># plot_matches(image0, image1, descriptors1, descriptors2, matches12[:10])</span>
    <span class="k">return</span> <span class="n">dx_median</span><span class="p">,</span> <span class="n">dy_median</span></div>


<div class="viewcode-block" id="sec2human"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.sec2human">[docs]</a><span class="k">def</span> <span class="nf">sec2human</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    formats a timedelta object into semi-fuzzy human readable time periods.</span>

<span class="sd">    :param seconds: seconds to format into a time period</span>
<span class="sd">    :type seconds: int or float</span>
<span class="sd">    :return: human readable string</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">periods</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">30</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;minute&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;second&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">strings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">period_name</span><span class="p">,</span> <span class="n">period_seconds</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">seconds</span> <span class="o">&gt;</span> <span class="n">period_seconds</span><span class="p">:</span>
            <span class="n">period_value</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="n">period_seconds</span><span class="p">)</span>
            <span class="n">fmt_st</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{val}</span><span class="s2"> </span><span class="si">{name}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">period_value</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{val}</span><span class="s2"> </span><span class="si">{name}</span><span class="s2">s&quot;</span>
            <span class="n">strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmt_st</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">period_value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">period_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strings</span><span class="p">)</span></div>


<div class="viewcode-block" id="Panorama"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama">[docs]</a><span class="k">class</span> <span class="nc">Panorama</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Panorama class.</span>
<span class="sd">    Provides the calibration and creation of tiled panoramas with a configuration file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">config_filename</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">config_filename</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;DEFAULT_PANO_NAME&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;/home/images/upload&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spool_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span>

        <span class="n">start_time_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;starttime&#39;</span><span class="p">,</span> <span class="s2">&quot;0000&quot;</span><span class="p">))</span>
        <span class="n">start_time_string</span> <span class="o">=</span> <span class="n">start_time_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">end_time_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stoptime&#39;</span><span class="p">,</span> <span class="s2">&quot;2359&quot;</span><span class="p">))</span>
        <span class="n">end_time_string</span> <span class="o">=</span> <span class="n">end_time_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">start_time_string</span> <span class="o">=</span> <span class="n">start_time_string</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">end_time_string</span> <span class="o">=</span> <span class="n">end_time_string</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">end_time_string</span><span class="o">.</span><span class="n">isdigit</span><span class="p">(),</span> <span class="s2">&quot;Non numerical start time, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">end_time_string</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">begin_capture</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_time_string</span><span class="p">,</span> <span class="s2">&quot;%H%M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">assert</span> <span class="n">end_time_string</span><span class="o">.</span><span class="n">isdigit</span><span class="p">(),</span> <span class="s2">&quot;Non numerical start time, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">end_time_string</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_capture</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_time_string</span><span class="p">,</span> <span class="s2">&quot;%H%M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
        <span class="n">camera</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ptz</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">camera</span><span class="p">:</span>
                <span class="n">camera_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;camera&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">camera_config</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No &#39;camera&#39; section found in config file.&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">camera_config</span> <span class="o">==</span> <span class="s2">&quot;DSLR&quot;</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">gphoto2cffi</span> <span class="k">as</span> <span class="nn">gp</span>
                    <span class="n">cameras</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">list_cameras</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">cameras</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;No DSLR connected.&quot;</span><span class="p">)</span>

                    <span class="n">camera</span> <span class="o">=</span> <span class="n">GPCamera</span><span class="p">(</span><span class="n">cameras</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">serialnumber</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">camera_config</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                    <span class="n">camera</span> <span class="o">=</span> <span class="n">IPCamera</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">camera_config</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldnt initialise Camera: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
            <span class="n">camera</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span> <span class="o">=</span> <span class="n">camera</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="p">:</span>
            <span class="n">fov</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;camera_fov&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fov</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">hfov</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">vfov</span> <span class="o">=</span> <span class="n">fov</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Camera initialised&quot;</span><span class="p">)</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">ptz</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ptz_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ptz&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ptz_config</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No &#39;ptz&#39; section found in config file.&quot;</span><span class="p">)</span>
                <span class="n">ptz</span> <span class="o">=</span> <span class="n">PanTilt</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">ptz_config</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ptz initialised&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldnt initialise PTZ: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                <span class="n">ptz</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span> <span class="o">=</span> <span class="n">ptz</span>


        <span class="c1"># this is vital to create the output folder</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_image_overlap</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overlap&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seconds_per_image</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_csv_log</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recovery_filename</span> <span class="o">=</span> <span class="s2">&quot;.gv_recover.json&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recovery_file</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">image_index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recovery_filename</span><span class="p">)):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recovery_filename</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_recovery_file</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recovery_filename</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_recovery_file</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="n">first_corner</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;first_corner&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>
        <span class="n">second_corner</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;second_corner&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">300</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">first_corner</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s2">&quot;first corner must be a list or tuple&quot;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">second_corner</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s2">&quot;second corner must be a list or tuple&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_corner</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;first corner must be of length 2&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">second_corner</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;second corner must be of length 2&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pan_range</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">first_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">second_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_range</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">first_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">second_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pan_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_step</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pan_pos_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_pos_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">focus_mode</span> <span class="o">=</span> <span class="s2">&quot;AUTO&quot;</span>

        <span class="n">scan_order_unparsed</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scan_order&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scan_order_translation</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;cols,right&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;cols,left&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;rows,down&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;rows,up&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;3&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span> <span class="mi">3</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scan_order_translation_r</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;cols,right&#39;</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;cols,left&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;rows,down&#39;</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;rows,up&#39;</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scan_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_order_translation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">scan_order_unparsed</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>

<div class="viewcode-block" id="Panorama.set_current_as_first_corner"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.set_current_as_first_corner">[docs]</a>    <span class="k">def</span> <span class="nf">set_current_as_first_corner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This and :func:`set_current_as_second_corner`, both internally call enumerate positions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_corner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">position</span></div>

<div class="viewcode-block" id="Panorama.set_current_as_second_corner"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.set_current_as_second_corner">[docs]</a>    <span class="k">def</span> <span class="nf">set_current_as_second_corner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See :func:`set_current_as_first_corner`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">second_corner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">position</span></div>

<div class="viewcode-block" id="Panorama.enumerate_positions"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.enumerate_positions">[docs]</a>    <span class="k">def</span> <span class="nf">enumerate_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uses the currrent image overlap, camera fov and corners to calculate a &quot;grid&quot; of pan and tilt positions.</span>

<span class="sd">        Also sets the internal enumeration of pan/tilt positions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Enumerating positions&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pan_step</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_overlap</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">hfov</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_step</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_overlap</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">vfov</span>
        <span class="n">pan_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pan_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pan_stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pan_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tilt_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tilt_stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_order</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># cols left</span>
            <span class="n">pan_start</span><span class="p">,</span> <span class="n">pan_stop</span> <span class="o">=</span> <span class="n">pan_stop</span><span class="p">,</span> <span class="n">pan_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pan_step</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_order</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># rows up</span>
            <span class="n">tilt_start</span><span class="p">,</span> <span class="n">tilt_stop</span> <span class="o">=</span> <span class="n">tilt_stop</span><span class="p">,</span> <span class="n">tilt_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_step</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pan_pos_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pan_start</span><span class="p">,</span> <span class="n">pan_stop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pan_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_pos_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tilt_start</span><span class="p">,</span> <span class="n">tilt_stop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_step</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;pan </span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pan_start</span><span class="p">,</span> <span class="n">pan_stop</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;tilt </span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tilt_start</span><span class="p">,</span> <span class="n">tilt_stop</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns a human readable summary of the panorama parameters.</span>
<span class="sd">        These include pan step, camera fov etc.</span>

<span class="sd">        :return: information about the panorama</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_positions</span><span class="p">()</span>
        <span class="n">max_num_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pan_pos_list</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tilt_pos_list</span><span class="p">)</span>
        <span class="n">last_image_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recovery_file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image_index&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;----- PANO SUMMARY -----</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;This panorama has </span><span class="si">{}</span><span class="s2">(H) x </span><span class="si">{}</span><span class="s2">(V) = </span><span class="si">{}</span><span class="s2"> images</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pan_pos_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tilt_pos_list</span><span class="p">),</span> <span class="n">max_num_images</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;Camera fov </span><span class="si">{0:.2f}</span><span class="s2">|</span><span class="si">{1:.2f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">hfov</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">vfov</span><span class="p">)</span>

        <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_seconds_per_image</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_num_images</span> <span class="o">-</span> <span class="n">last_image_index</span><span class="p">),</span> <span class="mi">60</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_image_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;RECOVERY AT </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">last_image_index</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;This will complete in approx </span><span class="si">{0:.2f}</span><span class="s2"> min </span><span class="si">{1:.2f}</span><span class="s2"> sec</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;pan step = </span><span class="si">{0:.3f}</span><span class="s2"> deg, tilt step = </span><span class="si">{1:.3f}</span><span class="s2"> deg</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pan_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_step</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;------------------------</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">camera</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Camera</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span>

    <span class="nd">@camera</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">camera</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Camera</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pantilt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PanTilt</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span>

    <span class="nd">@pantilt</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pantilt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">PanTilt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">image_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_overlap</span>

    <span class="nd">@image_overlap</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">image_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image_overlap</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scan_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_order_translation_r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scan_order</span><span class="p">,</span> <span class="s2">&quot;cols,right&quot;</span><span class="p">)</span>

    <span class="nd">@scan_order</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">scan_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scan_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_order_translation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span>

    <span class="nd">@output_dir</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">output_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Set the output folder to a string&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">panorama_fov</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the total fov of the Panorama.</span>

<span class="sd">        :return: total fov of the panorama as (hfov, vfov)</span>
<span class="sd">        :rtype: tuple[float, float]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pan_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_range</span>

    <span class="nd">@panorama_fov</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">panorama_fov</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets the pan range and tilt range of the panorama using the fov, and centre points</span>

<span class="sd">        :param value: 4 length tuple of pan_fov, tilt_fov, pan_centre, tilt_centre</span>
<span class="sd">        :type value: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pan_fov</span><span class="p">,</span> <span class="n">tilt_fov</span><span class="p">,</span> <span class="n">pan_centre</span><span class="p">,</span> <span class="n">tilt_centre</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must pass an iterable with the PanFov, TiltFov, PanCentre, TiltCentre&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pan_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">pan_centre</span> <span class="o">-</span> <span class="p">(</span><span class="n">pan_fov</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">pan_centre</span> <span class="o">+</span> <span class="p">(</span><span class="n">pan_fov</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">tilt_centre</span> <span class="o">-</span> <span class="p">(</span><span class="n">tilt_fov</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">tilt_centre</span> <span class="o">+</span> <span class="p">(</span><span class="n">tilt_fov</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_positions</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">first_corner</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        the starting corner of the panorama.</span>
<span class="sd">        :return: tuple of first corner as (pan,tilt)</span>
<span class="sd">        :rtype: tuple[float,float]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pan_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@first_corner</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">first_corner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s2">&quot;must be a list or tuple&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;must have 2 elements&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pan_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_positions</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: tuple of center position as (pan,tilt)</span>
<span class="sd">        :rtype: tuple[float,float]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_corner</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">second_corner</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">second_corner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        the finishing corner of the panorama.</span>
<span class="sd">        :return: tuple of second corner as (pan,tilt)</span>
<span class="sd">        :rtype: tuple[float,float]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pan_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@second_corner</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">second_corner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s2">&quot;must be a list or tuple&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;must have 2 elements&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pan_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_positions</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Panorama.format_calibration"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.format_calibration">[docs]</a>    <span class="k">def</span> <span class="nf">format_calibration</span><span class="p">(</span><span class="n">fovlists</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">test</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        formats a list of calibrated tuple of lists of fields of view and gives some statistics</span>
<span class="sd">        about the measurements.</span>

<span class="sd">        :param fovlists: 2 length tuple of lists of hfov and vfov - tuple(list(hfov), list(vfov))</span>
<span class="sd">        :type fovlists: tuple[ list(float), list(float) ]</span>
<span class="sd">        :param test: prefix for put before the output (ie, which number test it is)</span>
<span class="sd">        :type test: str</span>
<span class="sd">        :return: formattted string of the camera calibration.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{test_num}</span><span class="s2">).</span><span class="se">\n\t</span><span class="s2">HFOV:</span><span class="se">\n</span><span class="si">{havg:.2f}</span><span class="s2"></span><span class="si">{havar:.4f}</span><span class="s2">,</span><span class="se">\t</span><span class="s2">: </span><span class="si">{hstdev}</span><span class="se">\n\t</span><span class="s2">VFOV:</span><span class="se">\n</span><span class="si">{vavg:.2f}</span><span class="s2"></span><span class="si">{vavar:.4f}</span><span class="s2">,</span><span class="se">\t</span><span class="s2">: </span><span class="si">{vstdev:.4f}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fovlists</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">test_num</span><span class="o">=</span><span class="n">test</span><span class="p">,</span>
            <span class="n">havg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">h</span><span class="p">),</span>
            <span class="n">havar</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">h</span><span class="p">),</span>
            <span class="n">hstdev</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">h</span><span class="p">),</span>
            <span class="n">vavg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">v</span><span class="p">),</span>
            <span class="n">vavar</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">v</span><span class="p">),</span>
            <span class="n">vstdev</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Panorama.test_calibration"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.test_calibration">[docs]</a>    <span class="k">def</span> <span class="nf">test_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number_of_tests</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests the calibration process for accuracy, and prints the output values.</span>

<span class="sd">        :param number_of_tests: number of times to calibrate and compare calibration values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Testing </span><span class="si">{}</span><span class="s2"> times&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_of_tests</span><span class="p">))</span>

        <span class="c1"># tests = dict((_, int(random.uniform(1, 4))) for _ in range(number_of_tests))</span>
        <span class="k">def</span> <span class="nf">get_unif</span><span class="p">():</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">a</span>

        <span class="n">tests</span> <span class="o">=</span> <span class="p">{</span><span class="n">_</span><span class="p">:</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_tests</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">pan_range</span><span class="p">),</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">test</span><span class="p">,</span> <span class="n">inc</span> <span class="ow">in</span> <span class="n">tests</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Testing with opencv </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>
            <span class="n">fovlists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_fov_list</span><span class="p">(</span><span class="n">increment</span><span class="o">=</span><span class="n">inc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_calibration</span><span class="p">(</span><span class="n">fovlists</span><span class="p">,</span> <span class="n">test</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">pan_range</span><span class="p">),</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Testing without opencv </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>
            <span class="n">fovlists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_fov_list</span><span class="p">(</span><span class="n">increment</span><span class="o">=</span><span class="n">inc</span><span class="p">,</span> <span class="n">use_opencv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_calibration</span><span class="p">(</span><span class="n">fovlists</span><span class="p">,</span> <span class="n">test</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">pan_range</span><span class="p">),</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Panorama.calibrate_fov_list"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.calibrate_fov_list">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate_fov_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">zoom_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
                           <span class="n">panpos</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">tiltpos</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">increment</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                           <span class="n">use_opencv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calibrates the Panorama for a list of zoom levels.</span>

<span class="sd">        :param zoom_list: list of zoom positions to calibrate</span>
<span class="sd">        :param panpos: pan position to calibrate</span>
<span class="sd">        :param tiltpos: tilt &quot;&quot;</span>
<span class="sd">        :param increment: pan increment amount for the calibration</span>
<span class="sd">        :param use_opencv: whether to use opencv</span>
<span class="sd">        :return: 2 length tuple of lists of hfov and vfov - tuple(list(hfov), list(vfov))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">camhfovlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">camvfovlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">zoom_position</span> <span class="o">=</span> <span class="n">zoom_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">curpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">position</span>
        <span class="n">panpos</span> <span class="o">=</span> <span class="n">panpos</span> <span class="ow">or</span> <span class="n">curpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tiltpos</span> <span class="o">=</span> <span class="n">tiltpos</span> <span class="ow">or</span> <span class="n">curpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">zoompos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">zoom_list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">pan_range</span><span class="p">),</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">zoom_position</span> <span class="o">=</span> <span class="n">zoompos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calibrating </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">zoom_list</span><span class="p">)))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">hf</span><span class="p">,</span> <span class="n">vf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_fov</span><span class="p">(</span><span class="n">zoompos</span><span class="p">,</span> <span class="n">panpos</span><span class="p">,</span> <span class="n">tiltpos</span><span class="p">,</span> <span class="n">increment</span><span class="p">,</span> <span class="n">use_opencv</span><span class="o">=</span><span class="n">use_opencv</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">hf</span> <span class="ow">and</span> <span class="n">vf</span><span class="p">:</span>
                <span class="n">camhfovlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hf</span><span class="p">)</span>
                <span class="n">camvfovlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vf</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">panpos</span><span class="p">,</span> <span class="n">tiltpos</span>
        <span class="k">return</span> <span class="n">camhfovlist</span><span class="p">,</span> <span class="n">camvfovlist</span></div>

<div class="viewcode-block" id="Panorama.calibrate_fov"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.calibrate_fov">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate_fov</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">zoom_pos</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                      <span class="n">pan_pos</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                      <span class="n">tilt_pos</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                      <span class="n">increment</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                      <span class="n">use_opencv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Capture images at different pan/tilt angles, then measure the pixel</span>
<span class="sd">        displacement between the images to estimate the field-of-view angle.</span>

<span class="sd">        This function is also designed to reject outliers when measuring.</span>

<span class="sd">        :param zoom_pos: begin zoom position</span>
<span class="sd">        :type zoom_pos: float</span>
<span class="sd">        :param pan_pos: begin pan position</span>
<span class="sd">        :type pan_pos: float</span>
<span class="sd">        :param tilt_pos: begin tilt position</span>
<span class="sd">        :type tilt_pos: float</span>
<span class="sd">        :param increment: amount to increment to get displacement.</span>
<span class="sd">        :type increment: float</span>
<span class="sd">        :param use_opencv: Whether to use opencv or scikit image for displacement algorithm</span>
<span class="sd">        :type use_opencv: bool</span>
<span class="sd">        :return: tuple of hfov, vfov estimates</span>
<span class="sd">        :rtype: tuple[float,float]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">zoom_position</span> <span class="o">=</span> <span class="n">zoom_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">capture</span><span class="p">()</span>
        <span class="n">hestimates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vestimates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># add nearby position to reduce backlash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">pan_pos</span><span class="p">,</span> <span class="n">tilt_pos</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="n">hfov_estimate</span> <span class="o">=</span> <span class="n">vfov_estimate</span> <span class="o">=</span> <span class="n">hfov</span> <span class="o">=</span> <span class="n">vfov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">reference_image</span> <span class="o">=</span> <span class="n">displaced_image</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">reference_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">position</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">reference_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">capture</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">reference_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">reference_image</span> <span class="o">=</span> <span class="n">reference_image</span>
                <span class="k">break</span>

        <span class="k">def</span> <span class="nf">reject_outliers</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mf">2.</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                <span class="n">mdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">d</span> <span class="o">/</span> <span class="n">mdev</span> <span class="k">if</span> <span class="n">mdev</span> <span class="k">else</span> <span class="mf">0.</span>
                <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error rejecting outliers&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>

        <span class="k">def</span> <span class="nf">measure</span><span class="p">(</span><span class="n">movement</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">movement</span> <span class="o">=</span> <span class="p">(</span><span class="n">movement</span><span class="p">,</span> <span class="n">movement</span><span class="p">)</span>
            <span class="n">displ_image</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">pan_pos</span><span class="p">,</span> <span class="n">tilt_pos</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">position</span>

            <span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">movement</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">movement</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># print(&quot;Measuring at {}|{}&quot;.format(*position))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># make sure camera finishes refocusing</span>
                <span class="n">displ_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">capture</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">displ_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">use_opencv</span><span class="p">:</span>
                <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">get_displacement_opencv</span><span class="p">(</span><span class="n">reference_image</span><span class="p">,</span> <span class="n">displ_image</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">get_displacement</span><span class="p">(</span><span class="n">reference_image</span><span class="p">,</span> <span class="n">displ_image</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">dx</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dy</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Couldn&#39;t get displacement&quot;</span>

            <span class="n">dxp</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">/</span> <span class="n">reference_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dyp</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">/</span> <span class="n">reference_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dxp</span> <span class="o">&gt;</span> <span class="mf">0.35</span> <span class="ow">or</span> <span class="n">dyp</span> <span class="o">&gt;</span> <span class="mf">0.35</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

            <span class="n">ptzpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">position</span>

            <span class="n">displacement</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ptzpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">reference_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ptzpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">reference_position</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">displacement</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">movement</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Displacement error pan </span><span class="si">{0:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">displacement</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">movement</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">displacement</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">movement</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Displacement error tilt </span><span class="si">{0:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">displacement</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">movement</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

            <span class="n">hfovt</span> <span class="o">=</span> <span class="n">reference_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">displacement</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">dx</span>
            <span class="n">vfovt</span> <span class="o">=</span> <span class="n">reference_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">displacement</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">dy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Guess: </span><span class="si">{0:.3f}</span><span class="s2">|</span><span class="si">{1:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hfovt</span><span class="p">,</span> <span class="n">vfovt</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">hfovt</span><span class="p">,</span> <span class="n">vfovt</span>

        <span class="n">hestimates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vestimates</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">):</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">measure</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">increment</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">v</span><span class="p">)):</span>
                <span class="k">break</span>
            <span class="n">hestimates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="n">vestimates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;probably very wrong calibration for some reason&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">lh</span><span class="p">,</span> <span class="n">lv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hestimates</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">vestimates</span><span class="p">)</span>
        <span class="n">hestimates</span><span class="p">,</span> <span class="n">vestimates</span> <span class="o">=</span> <span class="n">reject_outliers</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hestimates</span><span class="p">)),</span> <span class="n">reject_outliers</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vestimates</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;removed outliers: h</span><span class="si">{}</span><span class="s2"> v</span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lh</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">hestimates</span><span class="p">),</span> <span class="n">lv</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">vestimates</span><span class="p">)))</span>
        <span class="n">hfov_estimate</span><span class="p">,</span> <span class="n">vfov_estimate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hestimates</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vestimates</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">Panorama</span><span class="o">.</span><span class="n">format_calibration</span><span class="p">((</span><span class="n">hestimates</span><span class="p">,</span> <span class="n">vestimates</span><span class="p">),</span> <span class="s2">&quot;This guess: &quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">pan_range</span><span class="p">),</span> <span class="mi">0</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hfov_estimate</span><span class="p">,</span> <span class="n">vfov_estimate</span></div>

<div class="viewcode-block" id="Panorama.quick_calibrate"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.quick_calibrate">[docs]</a>    <span class="k">def</span> <span class="nf">quick_calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">increment</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a quick calibration, a single time, and store the calibration values in the child camera object,</span>
<span class="sd">        and the child ptz object.</span>
<span class="sd">        :param increment: amount to increment by until we get optimal displacement.</span>
<span class="sd">        :type increment: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_fov</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">_zoom_position</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pan_range</span><span class="p">)),</span>
                                  <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tilt_range</span><span class="p">)),</span> <span class="n">increment</span><span class="o">=</span><span class="n">increment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">zoom_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">vfov_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">hfov_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">hfov</span> <span class="o">=</span> <span class="n">h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">vfov</span> <span class="o">=</span> <span class="n">v</span></div>

    <span class="k">def</span> <span class="nf">_init_csv_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_csv_log</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_csv_log</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_csv_log</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;image_index,pan_deg,tilt_deg,zoom_pos,focus_pos</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Panorama.load_csv_log"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.load_csv_log">[docs]</a>    <span class="k">def</span> <span class="nf">load_csv_log</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        loads a csv log into a dictionary so that we can continue to write to it.</span>

<span class="sd">        :return: dict of values in the csv.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_csv_log</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_csv_log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_csv_log</span><span class="p">)</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;image_index&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;pan_deg&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;tilt_deg&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;zoom_pos&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;focus_pos&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_csv_log</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">csvread</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csvread</span><span class="p">:</span>
                <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;image_index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;image_index&quot;</span><span class="p">]))</span>
                <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;pan_deg&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;pan_deg&quot;</span><span class="p">]))</span>
                <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;tilt_deg&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;tilt_deg&quot;</span><span class="p">]))</span>
                <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;zoom_pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;zoom_pos&quot;</span><span class="p">]))</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;focus_pos&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">fp</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                    <span class="n">fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">focus_position</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>

                <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;focus_pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cfg</span></div>

<div class="viewcode-block" id="Panorama.write_csv_log"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.write_csv_log">[docs]</a>    <span class="k">def</span> <span class="nf">write_csv_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_index</span><span class="p">,</span> <span class="n">pan_pos</span><span class="p">,</span> <span class="n">tilt_pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        writes a new line of values to the csv log.</span>

<span class="sd">        :param image_index: current index to be written</span>
<span class="sd">        :param pan_pos: the current pan position</span>
<span class="sd">        :param tilt_pos: the current tilt position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csv_log</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_csv_log</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_csv_log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">File</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">image_index</span><span class="p">,</span> <span class="n">pan_pos</span><span class="p">,</span> <span class="n">tilt_pos</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">zoom_position</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">focus_position</span><span class="p">))</span></div>

<div class="viewcode-block" id="Panorama.write_to_recovery_file"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.write_to_recovery_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_to_recovery_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">started_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        writes the current state to the recovery file.</span>

<span class="sd">        :param index: the current index into the panorama.</span>
<span class="sd">        :param started_time: the time the panorama was started.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recovery_file</span><span class="p">[</span><span class="s1">&#39;image_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recovery_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cols&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pan_pos_list</span><span class="p">),</span>
                    <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tilt_pos_list</span><span class="p">),</span>
                    <span class="s2">&quot;image_index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
                    <span class="s2">&quot;sec_per_image&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seconds_per_image</span><span class="p">,</span>
                    <span class="s2">&quot;started_time&quot;</span><span class="p">:</span> <span class="n">started_time</span><span class="p">}</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span></div>

<div class="viewcode-block" id="Panorama.take_panorama"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.take_panorama">[docs]</a>    <span class="k">def</span> <span class="nf">take_panorama</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        takes a panorama using the current values stored in this :class:`Panorama` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ts_fmt</span> <span class="o">=</span> <span class="s2">&quot;%Y_%m_</span><span class="si">%d</span><span class="s2">_%H_%M_00_00&quot;</span>
        <span class="n">last_image_captured</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Moving to center to focus...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pan_range</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tilt_range</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">focus</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">last_started</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recovery_file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;started_time&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_started</span><span class="p">:</span>
            <span class="n">last_started</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">last_started</span><span class="p">,</span> <span class="n">ts_fmt</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_started</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">last_started</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Recovery exists, but its now too late. Starting from beginning.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_to_recovery_file</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">ts_fmt</span><span class="p">))</span>
        <span class="n">this_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y_%m_</span><span class="si">%d</span><span class="s2">_%H&quot;</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">this_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_csv_log</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">-&quot;</span> <span class="o">+</span> <span class="n">ts_fmt</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_csv_log</span><span class="p">()</span>
        <span class="n">focus_list</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;focus_pos&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># this is just here in case you want to update overview.jpg</span>
        <span class="c1"># im1 = cv2.resize(self.camera.capture(), None, fx=0.1, fy=0.1)</span>
        <span class="c1"># overview = np.zeros((im1.shape[0]*len(self._tilt_pos_list),</span>
        <span class="c1">#                      im1.shape[1]*len(self._pan_pos_list),</span>
        <span class="c1">#                      3), np.uint8)</span>
        <span class="c1"># cv2.imwrite(&quot;overview.jpg&quot;, overview)</span>

        <span class="k">def</span> <span class="nf">cap</span><span class="p">(</span><span class="n">_pan_pos</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">_tilt_pos</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">_image_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">lcap</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            captures an image for the position _pan_pos,_tilt_pos with the image index _image_index</span>

<span class="sd">            :param _pan_pos: the pan position to take an image</span>
<span class="sd">            :param _tilt_pos: the tilt position to take an image</span>
<span class="sd">            :param _image_index: index of the current image. used to write the image filename.</span>
<span class="sd">            :param lcap: used to calculate how long capture is taking.</span>
<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">_pan_pos</span><span class="p">,</span> <span class="n">_tilt_pos</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write_csv_log</span><span class="p">(</span><span class="n">_image_index</span><span class="p">,</span> <span class="n">_pan_pos</span><span class="p">,</span> <span class="n">_tilt_pos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_to_recovery_file</span><span class="p">(</span><span class="n">_image_index</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">ts_fmt</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spool_dir</span><span class="p">,</span>
                                        <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">_&quot;</span> <span class="o">+</span> <span class="n">ts_fmt</span> <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{index:04}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                                                                <span class="n">index</span><span class="o">=</span><span class="n">_image_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">output_filenames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">capture</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">))</span>
                    <span class="c1"># output_filenames = self._camera.capture_monkey(filename=filename)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">communicate_with_updater</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">output_filenames</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_filenames</span><span class="p">):</span>
                        <span class="c1"># image = cv2.resize(self.camera.image.copy(),</span>
                        <span class="c1">#                    None, fx=0.1, fy=0.1,</span>
                        <span class="c1">#                    interpolation=cv2.INTER_NEAREST)</span>

                        <span class="c1"># yoff = _i * image.shape[0]</span>
                        <span class="c1"># xoff = _j * image.shape[1]</span>
                        <span class="c1"># overview[yoff:yoff+image.shape[0], xoff:xoff+image.shape[1]] = image</span>
                        <span class="c1"># cv2.imwrite(&quot;overview.jpg&quot;, overview)</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">output_filenames</span><span class="p">:</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">this_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;wrote image </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_image_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                                                    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pan_pos_list</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
                                                                        <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_pos_list</span><span class="p">))))</span>
                        <span class="n">lcap</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="c1"># update time per image</span>
                        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_seconds_per_image</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">/</span> <span class="n">lcap</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Seconds per image </span><span class="si">{0:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_seconds_per_image</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">lcap</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Bad things happened: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;failed capturing!&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">lcap</span>

        <span class="c1"># reverse it because we should start from top and go down</span>
        <span class="n">tilt_pos_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tilt_pos_list</span><span class="p">))</span>
        <span class="n">pan_pos_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pan_pos_list</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_order</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># cols left</span>
            <span class="n">pan_pos_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pan_pos_list</span>
            <span class="n">tilt_pos_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tilt_pos_list</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_order</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># rows up</span>
            <span class="n">tilt_pos_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tilt_pos_list</span>
            <span class="n">pan_pos_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pan_pos_list</span><span class="p">))</span>
        <span class="n">recovery_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recovery_file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;image_index&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_order</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tilt_pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tilt_pos_list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">pan_pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pan_pos_list</span><span class="p">):</span>
                    <span class="n">image_index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">pan_pos_list</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span>
                    <span class="k">if</span> <span class="n">image_index</span> <span class="o">&lt;</span> <span class="n">recovery_index</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">last_image_captured</span> <span class="o">=</span> <span class="n">cap</span><span class="p">(</span><span class="n">pan_pos</span><span class="p">,</span> <span class="n">tilt_pos</span><span class="p">,</span> <span class="n">image_index</span><span class="p">,</span> <span class="n">last_image_captured</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">pan_pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pan_pos_list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tilt_pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tilt_pos_list</span><span class="p">):</span>
                    <span class="n">image_index</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tilt_pos_list</span><span class="p">))</span> <span class="o">+</span> <span class="n">i</span>
                    <span class="k">if</span> <span class="n">image_index</span> <span class="o">&lt;</span> <span class="n">recovery_index</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">last_image_captured</span> <span class="o">=</span> <span class="n">cap</span><span class="p">(</span><span class="n">pan_pos</span><span class="p">,</span> <span class="n">tilt_pos</span><span class="p">,</span> <span class="n">image_index</span><span class="p">,</span> <span class="n">last_image_captured</span><span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_csv_log</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_csv_log</span><span class="p">)))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recovery_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recovery_file</span><span class="p">[</span><span class="s1">&#39;image_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Panorama complete in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sec2human</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Panorama.calibrate_and_run"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.calibrate_and_run">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate_and_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calibrates, and takes a panorama.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pantilt</span><span class="o">.</span><span class="n">pan_range</span><span class="p">),</span> <span class="mi">0</span>
        <span class="n">fovlists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_fov_list</span><span class="p">(</span><span class="n">zoom_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> <span class="n">increment</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calibration complete&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">Panorama</span><span class="o">.</span><span class="n">format_calibration</span><span class="p">(</span><span class="n">fovlists</span><span class="p">,</span> <span class="s2">&quot;Calibration results: &quot;</span><span class="p">))</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fovlists</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">zoom_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">vfov_list</span> <span class="o">=</span> <span class="n">v</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">hfov_list</span> <span class="o">=</span> <span class="n">h</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">hfov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_camera</span><span class="o">.</span><span class="n">vfov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_positions</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">take_panorama</span><span class="p">()</span></div>

<div class="viewcode-block" id="Panorama.run_from_config"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.run_from_config">[docs]</a>    <span class="k">def</span> <span class="nf">run_from_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints the summary and takes a panorama</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">take_panorama</span><span class="p">()</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Panorama.time2seconds"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.time2seconds">[docs]</a>    <span class="k">def</span> <span class="nf">time2seconds</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        converts a datetime to an integer of seconds since epoch</span>

<span class="sd">        :return: seconds since 1970-01-01 00:00</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># only implemented in python3.3</span>
            <span class="c1"># this is an old compatibility thing</span>
            <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">hour</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">minute</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">second</span></div>

<div class="viewcode-block" id="Panorama.time_to_capture"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.time_to_capture">[docs]</a>    <span class="k">def</span> <span class="nf">time_to_capture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        filters out times for capture, returns True by default</span>
<span class="sd">        returns False if the conditions where the camera should NOT capture are met.</span>

<span class="sd">        :return: whether we should start capturing images now or not</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_capture_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">current_naive_time</span> <span class="o">=</span> <span class="n">current_capture_time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_capture</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_capture</span><span class="p">:</span>
            <span class="c1"># where the start capture time is less than the end capture time</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_capture</span> <span class="o">&lt;=</span> <span class="n">current_naive_time</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_capture</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># where the start capture time is greater than the end capture time</span>
            <span class="c1"># i.e. capturing across midnight.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_capture</span> <span class="o">&lt;=</span> <span class="n">current_naive_time</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_capture</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># capture interval</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time2seconds</span><span class="p">(</span><span class="n">current_capture_time</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">&lt;</span> <span class="n">Panorama</span><span class="o">.</span><span class="n">accuracy</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">next_pano</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calculates the amount of time until the next panorama</span>

<span class="sd">        :return: time until the next panorama (in seconds)</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nextin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time2seconds</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="n">nowstamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time2seconds</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">nextin</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nextin</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Panorama</span><span class="o">.</span><span class="n">accuracy</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">nextin</span> <span class="o">-</span> <span class="n">nowstamp</span>

<div class="viewcode-block" id="Panorama.run_loop"><a class="viewcode-back" href="../pantiltzoomlib.html#pantiltzoomlib.Panorama.run_loop">[docs]</a>    <span class="k">def</span> <span class="nf">run_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        runs the panorama taker in a loop based on the interval in the config file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_to_capture</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">take_panorama</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Next pano in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sec2human</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_pano</span><span class="p">)))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Usage </span><span class="se">\&quot;</span><span class="s2">script.py /path/to/config.yml</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="n">config_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">updater</span> <span class="o">=</span> <span class="n">Updater</span><span class="p">()</span>
    <span class="c1"># updater.start()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_fh</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config_fh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="n">pano</span> <span class="o">=</span> <span class="n">Panorama</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">updater</span><span class="o">.</span><span class="n">communication_queue</span><span class="p">)</span>

    <span class="c1"># pano.test_calibration(1)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enabled&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">uploader</span> <span class="o">=</span> <span class="n">GenericUploader</span><span class="p">(</span><span class="n">pano</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">uploader</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">uploader</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">pano</span><span class="o">.</span><span class="n">take_panorama</span><span class="p">()</span>
    <span class="n">pano</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Next pano in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sec2human</span><span class="p">(</span><span class="n">pano</span><span class="o">.</span><span class="n">next_pano</span><span class="p">)))</span>
    <span class="n">pano</span><span class="o">.</span><span class="n">run_loop</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2017, Gareth Dunstone, Chuong Nguyen, Tim Brown.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>